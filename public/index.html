<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Media Session</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/materialize.min.css">
</head>

<body>

    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper black">
                <a href="#!" class="brand-logo">Media Session</a>
        </nav>
    </div>

    <div class="container" style="margin-top: 60px;">
        <button id="playButton" class="btn black">▶ PLAY</button>
        <button id="pauseButton" class="btn black"><b>||</b> PAUSE </button>
    </div>

    <div id="box" class="container" style="margin-top: 60px;">
        
    </div>


    <script>


        playButton = document.querySelector('#playButton');
        pauseButton = document.querySelector('#pauseButton');
        //text = document.querySelector('#header');

        
        playButton.addEventListener('click', onPlayButtonClick);
        pauseButton.addEventListener('click', pauseAudio);

        if (!('mediaSession' in navigator)) {
            console.log('The Media Session API is not yet available. Try Chrome for Android.');
        }

        // This prevents unnecessary errors when Media Session API is not available.
        navigator.mediaSession = navigator.mediaSession || {};
        navigator.mediaSession.setActionHandler = navigator.mediaSession.setActionHandler || function () { };
        window.MediaMetadata = window.MediaMetadata || function () { };

        //log = ChromeSamples.log;
        let audio = document.createElement('audio');

        let playlist = getAwesomePlaylist();
        let index = 0;

        function onPlayButtonClick() {
            playAudio();
        }

        function playAudio() {
            //document.querySelector('#header').innerHTML("▶");
            audio.src = playlist[index].src;
            audio.play()
                .then(_ => updateMetadata())
                .catch(error => console.log(error));
        }

        function pauseAudio() {
            audio.pause();
        }

        function updateMetadata() {
            let track = playlist[index];

            console.log('Playing ' + track.title + ' track...');
            navigator.mediaSession.metadata = new MediaMetadata({
                title: track.title,
                artist: track.artist,
                album: track.album,
                artwork: track.artwork
            });

            // Media is loaded, set the duration.
            updatePositionState();
        }

        /* Position state (supported since Chrome 81) */

        function updatePositionState() {
            if ('setPositionState' in navigator.mediaSession) {
                console.log('Updating position state...');
                navigator.mediaSession.setPositionState({
                    duration: audio.duration,
                    playbackRate: audio.playbackRate,
                    position: audio.currentTime
                });
            }
        }

        /* Previous Track & Next Track */

        navigator.mediaSession.setActionHandler('previoustrack', function () {
            console.log('> User clicked "Previous Track" icon.');
            index = (index - 1 + playlist.length) % playlist.length;
            playAudio();
        });

        navigator.mediaSession.setActionHandler('nexttrack', function () {
            console.log('> User clicked "Next Track" icon.');
            index = (index + 1) % playlist.length;
            playAudio();
        });

        audio.addEventListener('ended', function () {
            // Play automatically the next track when audio ends.
            index = (index - 1 + playlist.length) % playlist.length;
            playAudio();
        });

        /* Seek Backward & Seek Forward */

        let defaultSkipTime = 10; /* Time to skip in seconds by default */

        navigator.mediaSession.setActionHandler('seekbackward', function (event) {
            console.log('> User clicked "Seek Backward" icon.');
            const skipTime = event.seekOffset || defaultSkipTime;
            audio.currentTime = Math.max(audio.currentTime - skipTime, 0);
            updatePositionState();
        });

        navigator.mediaSession.setActionHandler('seekforward', function (event) {
            console.log('> User clicked "Seek Forward" icon.');
            const skipTime = event.seekOffset || defaultSkipTime;
            audio.currentTime = Math.min(audio.currentTime + skipTime, audio.duration);
            updatePositionState();
        });

        /* Play & Pause */

        navigator.mediaSession.setActionHandler('play', async function () {
            console.log('> User clicked "Play" icon.');
            await audio.play();
            navigator.mediaSession.playbackState = "playing";
            // Do something more than just playing audio...
        });

        navigator.mediaSession.setActionHandler('pause', function () {
            console.log('> User clicked "Pause" icon.');
            audio.pause();
            navigator.mediaSession.playbackState = "paused";
            // Do something more than just pausing audio...
        });

        /* Stop (supported since Chrome 77) */

        try {
            navigator.mediaSession.setActionHandler('stop', function () {
                console.log('> User clicked "Stop" icon.');
                // TODO: Clear UI playback...
            });
        } catch (error) {
            console.log('Warning! The "stop" media session action is not supported.');
        }

        /* Seek To (supported since Chrome 78) */

        try {
            navigator.mediaSession.setActionHandler('seekto', function (event) {
                console.log('> User clicked "Seek To" icon.');
                if (event.fastSeek && ('fastSeek' in audio)) {
                    audio.fastSeek(event.seekTime);
                    return;
                }
                audio.currentTime = event.seekTime;
                updatePositionState();
            });
        } catch (error) {
            console.log('Warning! The "seekto" media session action is not supported.');
        }

        /* Utils */

        function getAwesomePlaylist() {
            //const BASE_URL = 'https://storage.googleapis.com/media-session/';

            return [{
                src: '/music/symphony.mp3',
                title: 'Symphony No. 5',
                artist: 'Beethoven',
                artwork: [
                    { src: '/music/beethoven-384.png', sizes: '384x384', type: 'image/png' },
                    { src: '/music/beethoven-512.png', sizes: '512x512', type: 'image/png' }
                ]
            }, {
                src: '/music/valkyrie.mp3',
                title: 'Ride of the Valkyrie',
                artist: 'Wagner',
                artwork: [
                    { src: '/music/wagner-384.png', sizes: '384x384', type: 'image/png' },
                    { src: '/music/wagner-512.png', sizes: '512x512', type: 'image/png' }
                ]
            }];
        }
    </script>

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/materialize.min.js"></script>

</body>

</html>